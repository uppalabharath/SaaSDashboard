-- DDL for tables --
ALTER TABLE SPENTERPRISE ADD ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL;
ALTER TABLE SPENTERPRISE ADD ROWMODIFIEDDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL;
ALTER TABLE SPENTERPRISE MODIFY ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL;
CREATE TABLE SPPRODUCT
  (
    PRODUCT_ID    NUMBER(9),
    NAME          VARCHAR2(255) NOT NULL,
    ENTERPRISE_ID NUMBER(9),
    ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    ROWMODIFIEDDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT SPPRODUCT_PK PRIMARY KEY (PRODUCT_ID),
    CONSTRAINT PRODUCT_ENT_FK FOREIGN KEY (ENTERPRISE_ID) REFERENCES SPENTERPRISE(ENTERPRISE_ID)
  );
  
  INSERT INTO SPPRODUCT (PRODUCT_ID,NAME,ENTERPRISE_ID) VALUES (SPPRODUCT_S.NEXTVAL,?,?);

SELECT P.PRODUCT_ID,P.NAME,P.REVENUE,P.ENTERPRISE_ID,E.NAME FROM SPPRODUCT P INNER JOIN SPENTERPRISE E ON P.ENTERPRISE_ID = E.ENTERPRISE_ID WHERE P.PRODUCT_ID=8;

SELECT P.PRODUCT_ID,P.NAME,P.REVENUE,P.ENTERPRISE_ID,E.NAME FROM SPPRODUCT P INNER JOIN SPENTERPRISE E ON P.ENTERPRISE_ID = E.ENTERPRISE_ID WHERE P.ENTERPRISE_ID=1;

UPDATE SPPRODUCT SET NAME=?,ENTERPRISE_ID=?,ROWMODIFIEDDATE=CURRENT_TIMESTAMP WHERE PRODUCT_ID=?;

DELETE FROM SPPRODUCT WHERE PRODUCT_ID = ?;

CREATE TABLE SPPRODUCTDETAIL
  (
    PRODUCTDETAIL_ID    NUMBER(9),
    --NAME          VARCHAR2(255) NOT NULL,
    PRODUCT_ID NUMBER(9),
    BLOCK1 CLOB,
    BLOCK2 CLOB,
    BLOCK3 CLOB,
    ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    ROWMODIFIEDDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT SPPRODUCTDETAIL_PK PRIMARY KEY (PRODUCTDETAIL_ID),
    CONSTRAINT PRODUCTDETAIL_PRODUCT_FK FOREIGN KEY (PRODUCT_ID) REFERENCES SPPRODUCT(PRODUCT_ID)
  );
  ALTER TABLE SPPRODUCTDETAIL ADD CONSTRAINT PRODDET_PROD_U UNIQUE (PRODUCT_ID);
  ALTER TABLE SPPRODUCTDETAIL MODIFY PRODUCT_ID NUMBER(9) NOT NULL;
  SELECT * FROM SPPRODUCTDETAIL;
  INSERT INTO SPPRODUCTDETAIL (PRODUCTDETAIL_ID,PRODUCT_ID,BLOCK1,BLOCK2,BLOCK3) VALUES (SPPRODUCTDETAIL_S.NEXTVAL,?,?,?,?);
  SELECT * FROM SPPRODUCT;
  
  CREATE TABLE SPCUSTOMER
  (
    CUSTOMER_ID    NUMBER(9),
    NAME          VARCHAR2(255) NOT NULL,
    PRODUCT_ID NUMBER(9),
    EMAIL VARCHAR2(255),
    REPUTATION NUMBER(11,3),
    ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    ROWMODIFIEDDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT SPCUSTOMER_PK PRIMARY KEY (CUSTOMER_ID),
    CONSTRAINT CUSTOMER_PRODUCT_FK FOREIGN KEY (PRODUCT_ID) REFERENCES SPPRODUCT(PRODUCT_ID)
  );
  
  CREATE TABLE SPCUSTOMERREVENUE
  (
    REVENUE_ID    NUMBER(9),
    --NAME          VARCHAR2(255) NOT NULL,
    MONTH NUMBER(2),
    YEAR NUMBER(4),
    CUSTOMER_ID NUMBER(9),
    --EMAIL VARCHAR2(255),
    --REPUTATION NUMBER(11,3),
    AMOUNT NUMBER(11,3),
    ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    ROWMODIFIEDDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT SPCUSTOMERREVENUE_PK PRIMARY KEY (REVENUE_ID),
    CONSTRAINT CUSTOMERREVENUE_CUSTOMER_FK FOREIGN KEY (CUSTOMER_ID) REFERENCES SPCUSTOMER(CUSTOMER_ID)
  );
  
  CREATE TABLE SPFEATUREREQUEST
  (
    REQUEST_ID    NUMBER(9),
    SUBJECT          VARCHAR2(255) NOT NULL,
    DESCRIPTION CLOB,
    IMPACT_FACTOR NUMBER(3),
    --YEAR NUMBER(4),
    CUSTOMER_ID NUMBER(9),
    --EMAIL VARCHAR2(255),
    --REPUTATION NUMBER(11,3),
    --AMOUNT NUMBER(11,3),
    ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    ROWMODIFIEDDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT SPFEATUREREQUEST_PK PRIMARY KEY (REQUEST_ID),
    CONSTRAINT FEATUREREQUEST_CUSTOMER_FK FOREIGN KEY (CUSTOMER_ID) REFERENCES SPCUSTOMER(CUSTOMER_ID)
  );
  
    ALTER TABLE SPFEATUREREQUEST ADD UPVOTE NUMBER(4);
    
    CREATE TABLE SPWORKAROUND
  (
    WORKAROUND_ID    NUMBER(9),
    --SUBJECT          VARCHAR2(255) NOT NULL,
    DESCRIPTION CLOB,
    --IMPACT_FACTOR NUMBER(3),
    CUSTOMER_ID NUMBER(9),
    REQUEST_ID NUMBER(9),
    UPVOTE NUMBER(4),
    --EMAIL VARCHAR2(255),
    --REPUTATION NUMBER(11,3),
    --AMOUNT NUMBER(11,3),
    ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    ROWMODIFIEDDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT SPWORKAROUND_PK PRIMARY KEY (WORKAROUND_ID),
    CONSTRAINT WORKAROUND_CUSTOMER_FK FOREIGN KEY (CUSTOMER_ID) REFERENCES SPCUSTOMER(CUSTOMER_ID),
    CONSTRAINT WORKAROUND_REQUEST_FK FOREIGN KEY (REQUEST_ID) REFERENCES SPFEATUREREQUEST(REQUEST_ID)
  );
  
  CREATE TABLE SPFEATUREREQVOTEDETAIL
  (
    REQUEST_ID    NUMBER(9),
    --SUBJECT          VARCHAR2(255) NOT NULL,
    --DESCRIPTION CLOB,
    --IMPACT_FACTOR NUMBER(3),
    CUSTOMER_ID NUMBER(9),
    --REQUEST_ID NUMBER(9),
    --UPVOTE NUMBER(4),
    --EMAIL VARCHAR2(255),
    --REPUTATION NUMBER(11,3),
    --AMOUNT NUMBER(11,3),
    ROWCREATIONDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    ROWMODIFIEDDATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT SPFEATUREREQVOTEDETAIL_PK PRIMARY KEY (REQUEST_ID,CUSTOMER_ID),
    CONSTRAINT REQVOTE_CUSTOMER_FK FOREIGN KEY (CUSTOMER_ID) REFERENCES SPCUSTOMER(CUSTOMER_ID),
    CONSTRAINT REQVOTE_FEATUREREQ_FK FOREIGN KEY (REQUEST_ID) REFERENCES SPFEATUREREQUEST(REQUEST_ID)
  );
  
  alter table spcustomerrevenue modify month number(2) not null;
alter table spcustomerrevenue modify year number(4) not null;
alter table spcustomerrevenue modify customer_id number(9) not null;
alter table spcustomerrevenue modify amount number(11,3) not null;
alter table spfeaturerequest modify impact_factor number(5,2) default 0 not null ;

INSERT INTO SPCUSTOMER(CUSTOMER_ID,NAME,PRODUCT_ID,EMAIL,REPUTATION,ROWCREATIONDATE,ROWMODIFIEDDATE) VALUES (SPCUSTOMER_S.NEXTVAL,?,?,?,0,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP);

SELECT CUST.CUSTOMER_ID,CUST.NAME,CUST.EMAIL,CUST.REPUTATION,PROD.NAME FROM SPCUSTOMER CUST INNER JOIN SPPRODUCT PROD ON CUST.PRODUCT_ID = PROD.PRODUCT_ID WHERE CUST.CUSTOMER_ID=?;

SELECT CUST.CUSTOMER_ID,CUST.NAME,CUST.EMAIL,CUST.REPUTATION,PROD.NAME FROM SPCUSTOMER CUST INNER JOIN SPPRODUCT PROD ON CUST.PRODUCT_ID = PROD.PRODUCT_ID WHERE PROD.PRODUCT_ID=?;

UPDATE SPCUSTOMER SET NAME=?,PRODUCT_ID=?,EMAIL=? WHERE CUSTOMER_ID = ?;

DELETE FROM SPCUSTOMER WHERE CUSTOMER_ID = ?; 

alter table spcustomer add revenue number(15,3) default 0 not null;
alter table spproduct add revenue number(15,3) default 0 not null;

alter table spproduct add reputation number(15,3) default 0 not null ;
ALTER TABLE spcustomerrevenue
ADD CONSTRAINT revenue_unique UNIQUE (MONTH, YEAR,CUSTOMER_ID);
ALTER TABLE spcustomerrevenue add constraint revenue_month_chk check (0 < month and month < 13);

INSERT INTO SPCUSTOMERREVENUE (REVENUE_ID,MONTH,YEAR,CUSTOMER_ID,AMOUNT,ROWCREATIONDATE,ROWMODIFIEDDATE ) Values (SPCUSTOMERREVENUE_S.NEXTVAL,?,?,?,?,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP);

MERGE INTO SPCUSTOMER CUS USING
(SELECT CUSTOMER_ID,REVENUE,REPUTATION FROM SPCUSTOMER WHERE CUSTOMER_ID=?
) TMP ON (CUS.CUSTOMER_ID = TMP.CUSTOMER_ID) 
WHEN MATCHED THEN
  UPDATE SET CUS.REVENUE=TMP.REVENUE+?,
  CUS.REPUTATION = TMP.REPUTATION+?,
  CUS.ROWMODIFIEDDATE = CURRENT_TIMESTAMP;

MERGE INTO SPPRODUCT PROD USING
(SELECT PRODUCT_ID,REVENUE,REPUTATION FROM SPPRODUCT WHERE PRODUCT_ID=?
) TMP ON (PROD.PRODUCT_ID = TMP.PRODUCT_ID) 
WHEN MATCHED THEN
  UPDATE SET PROD.REVENUE=TMP.REVENUE+?,
  PROD.REPUTATION = TMP.REPUTATION+?,
  PROD.ROWMODIFIEDDATE = CURRENT_TIMESTAMP;
  
  DELETE FROM SPCUSTOMERREVENUE WHERE CUSTOMER_ID=? AND MONTH=? AND YEAR=?;
  SELECT CUSTOMER_ID,MONTH,YEAR,AMOUNT FROM SPCUSTOMERREVENUE WHERE CUSTOMER_ID=? ORDER BY YEAR,MONTH;
  
  SELECT REV.CUSTOMER_ID,REV.MONTH,REV.YEAR,REV.AMOUNT
  FROM SPPRODUCT PROD
  INNER JOIN SPCUSTOMER CUST
  ON PROD.PRODUCT_ID = CUST.PRODUCT_ID
  INNER JOIN SPCUSTOMERREVENUE REV ON CUST.CUSTOMER_ID=REV.CUSTOMER_ID WHERE PROD.PRODUCT_ID=? ORDER BY REV.YEAR,REV.MONTH;
  
  INSERT INTO SPFEATUREREQUEST (REQUEST_ID,SUBJECT,DESCRIPTION,IMPACT_FACTOR,CUSTOMER_ID,UPVOTE,ROWCREATIONDATE,ROWMODIFIEDDATE) VALUES (SPFEATUREREQUEST_S.NEXTVAL,?,?,?,?,?,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP);
  
  SELECT REQ.REQUEST_ID,REQ.SUBJECT,REQ.DESCRIPTION,REQ.IMPACT_FACTOR,REQ.UPVOTE,
  REQ.ROWCREATIONDATE,REQ.CUSTOMER_ID,CUST.NAME,PROD.PRODUCT_ID,PROD.NAME FROM SPFEATUREREQUEST REQ 
  INNER JOIN SPCUSTOMER CUST ON REQ.CUSTOMER_ID=CUST.CUSTOMER_ID 
  INNER JOIN SPPRODUCT PROD ON PROD.PRODUCT_ID = CUST.PRODUCT_ID
  WHERE REQ.REQUEST_ID=?;
  
  SELECT REQ.REQUEST_ID,REQ.SUBJECT,REQ.DESCRIPTION,REQ.IMPACT_FACTOR,REQ.UPVOTE,
  REQ.ROWCREATIONDATE,REQ.ISFREEZED,REQ.CUSTOMER_ID,CUST.NAME,PROD.PRODUCT_ID,PROD.NAME FROM SPFEATUREREQUEST REQ 
  INNER JOIN SPCUSTOMER CUST ON REQ.CUSTOMER_ID=CUST.CUSTOMER_ID INNER JOIN SPPRODUCT PROD ON 
  PROD.PRODUCT_ID = CUST.PRODUCT_ID
  WHERE REQ.CUSTOMER_ID=? ORDER BY REQ.IMPACT_FACTOR DESC;
  
  UPDATE SPFEATUREREQUEST SET SUBJECT=?,DESCRIPTION=?,ROWMODIFIEDDATE=CURRENT_TIMESTAMP WHERE CUSTOMER_ID=? AND REQUEST_ID=?;
  
  ALTER TABLE SPFEATUREREQUEST ADD ISFREEZED NUMBER(1) DEFAULT 0 NOT NULL;
  ALTER TABLE SPFEATUREREQUEST add constraint request_freezed check (ISFREEZED IN (0,1));
  UPDATE SPFEATUREREQUEST SET UPVOTE=(SELECT UPVOTE FROM SPFEATUREREQUEST WHERE REQUEST_ID=?)+1,ROWMODIFIEDDATE=CURRENT_TIMESTAMP WHERE REQUEST_IS=?
  
  INSERT INTO SPFEATUREREQVOTEDETAIL (REQUEST_ID,CUSTOMER_ID,ROWCREATIONDATE,ROWMODIFIEDDATE) VALUES (?,?,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP);
  
  MERGE INTO SPFEATUREREQUEST REQ USING
(SELECT REQUEST_ID,IMPACT_FACTOR,UPVOTE FROM SPFEATUREREQUEST WHERE REQUEST_ID=?
) TMP ON (REQ.REQUEST_ID = TMP.REQUEST_ID) 
WHEN MATCHED THEN
  UPDATE SET REQ.IMPACT_FACTOR=TMP.IMPACT_FACTOR+?,
  REQ.UPVOTE = TMP.UPVOTE+?,
  REQ.ROWMODIFIEDDATE = CURRENT_TIMESTAMP;